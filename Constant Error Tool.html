<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constant Error Teaching Tool</title>
    <style>
        /* scope the font only to this tool */
        #constant-error-tool {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #f9fafb;
            color: #1f2937;
            margin: 0;
        }
        #constant-error-tool .container {
            max-width: 1280px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            #constant-error-tool .container {
                padding: 2rem;
            }
        }
        #constant-error-tool header {
            text-align: center;
            margin-bottom: 2rem;
        }
        #constant-error-tool header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
        }
        @media (min-width: 768px) {
            #constant-error-tool header h1 {
                font-size: 2.25rem;
            }
        }
        #constant-error-tool header p {
            margin-top: 0.5rem;
            font-size: 1.125rem;
            color: #4b5563;
        }
        #constant-error-tool .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            #constant-error-tool .main-grid {
                grid-template-columns: repeat(12, 1fr);
            }
            #constant-error-tool .panel-controls { grid-column: span 3; }
            #constant-error-tool .panel-dartboard { grid-column: span 5; }
            #constant-error-tool .panel-results { grid-column: span 4; }
        }
        #constant-error-tool .panel {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        #constant-error-tool .panel h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
        }
        .panel-controls .instructions p {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 1rem;
        }
        .panel-controls .instructions p:last-child { margin-bottom: 0; }
        #throw-counter-container { margin-top: 1.5rem; }
        #throw-counter-container h3 { font-size: 1.125rem; font-weight: 700; }
        #throw-counter-container .counter-display {
            text-align: center;
            font-size: 2.25rem;
            font-family: monospace;
            font-weight: 700;
            color: #2563eb;
            margin-top: 0.5rem;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .panel-controls .reset-container {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        #resetBtn {
            width: 100%;
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #resetBtn:hover { background-color: #d1d5db; }
        .panel-dartboard {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        #dartboard-container {
            position: relative;
            width: 100%;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scale-container {
            height: 100%;
            width: 2rem;
            font-size: 0.75rem;
            text-align: right;
            padding-right: 0.5rem;
            color: #6b7280;
            position: relative;
        }
        .scale-container div { position: absolute; right: 0.5rem; }
        .scale-container .scale-0 { font-weight: 700; transform: translateY(-50%); }
        #constant-error-tool #targetArea {
            cursor: crosshair;
            background: radial-gradient(
              circle at center,
              #c0392b        0% 12%,
              #27ae60       12% 22%,
              #000000       22% 42%,
              #ecf0f1       42% 62%,
              #000000       62% 82%,
              transparent   82% 100%
            );
            border: 8px solid #2d3436;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.6);
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            max-height: 500px;
            border-radius: 9999px;
            overflow: visible;
        }
        .true-value-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #ef4444;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .true-value-line span {
            position: absolute;
            right: -3.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 700;
            color: #ef4444;
            background-color: #fff;
            padding: 0 0.25rem;
            border-radius: 0.25rem;
        }
        #averageLine {
            position: absolute;
            width: 100%;
            height: 4px;
            background-color: #2563eb;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease-out;
            pointer-events: none;
        }
        #averageLine.hidden { display: none; }
        #averageLineLabel {
            position: absolute;
            left: -5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 700;
            color: #2563eb;
            background-color: #fff;
            padding: 0 0.25rem;
            border-radius: 0.25rem;
        }
        #results-content .placeholder {
            text-align: center;
            color: #6b7280;
            margin-top: 4rem;
        }
        #summary-container { margin-bottom: 1rem; }
        #summary-container h3 { font-weight: 700; color: #1f2937; }
        .summary-box {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
        }
        .summary-box > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .summary-box > div:last-child { margin-bottom: 0; }
        .summary-box .label { font-size: 0.875rem; font-weight: 500; }
        .summary-box .value { font-size: 1.125rem; font-weight: 700; color: #2563eb; }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .log-header h3 { font-weight: 700; color: #1f2937; }
        #copyLogBtn {
            color: #2563eb;
            text-decoration: none;
            font-size: 0.875rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        #copyLogBtn:hover { text-decoration: underline; }
        #throw-log {
            margin-top: 0.5rem;
            height: 16rem;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #fff;
            list-style: none;
        }
        #throw-log li {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        #throw-log li:nth-child(even) { background-color: #f9fafb; }
        #throw-log .value { font-family: monospace; font-weight: 600; }
        .dart {
            position: absolute;
            width: 1rem;
            height: 1rem;
            background-color: #1f2937;
            border-radius: 9999px;
            border: 2px solid white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            transform: translate(-50%, -50%);
        }
        .full-message {
            text-align: center;
            color: #ef4444;
            font-weight: 600;
            margin-top: 1rem;
        }
        #constant-error-tool .tooltip {
            position: relative;
            cursor: help;
        }
        #constant-error-tool .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            max-width: 320px;
            background-color: #2d3436;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            font-size: 0.8rem;
            font-weight: 500;
            pointer-events: none;
            line-height: 1.4;
        }
        #constant-error-tool .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        #constant-error-tool #chatbot-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 50;
            background: #2563eb;
            color: white;
            border-radius: 9999px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 2rem;
            outline: none;
            border: none;
        }
        #constant-error-tool #chatbot-btn.is-unavailable {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.65;
        }
        #constant-error-tool #chatbot-btn.is-active {
            animation: chatbot-pulse 3s ease-in-out infinite;
        }
        @keyframes chatbot-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37,99,235,0.45); }
            50% { box-shadow: 0 0 0 10px rgba(37,99,235,0); }
        }
        #constant-error-tool #chatbot-btn.has-notification::after {
            content: "";
            position: absolute;
            top: 6px;
            right: 6px;
            width: 14px;
            height: 14px;
            background: #ef4444;
            border: 2px solid #fff;
            border-radius: 50%;
        }
        #constant-error-tool #chatbot-modal {
            position: fixed;
            bottom: 100px;
            right: 32px;
            width: 350px;
            max-width: 90vw;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: none;
        }
        #constant-error-tool #chatbot-modal.resizing {
            user-select: none;
            pointer-events: none;
        }
        #constant-error-tool #chatbot-header {
            background: #2563eb;
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #constant-error-tool #chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
        }
        #constant-error-tool #chatbot-messages {
            padding: 1rem;
            height: 260px;
            overflow-y: auto;
            background: #f3f4f6;
            font-size: 0.95rem;
        }
        #constant-error-tool .chatbot-msg-user {
            text-align: right;
            margin-bottom: 0.5rem;
        }
        #constant-error-tool .chatbot-msg-assistant {
            text-align: left;
            margin-bottom: 0.5rem;
        }
        #constant-error-tool #chatbot-input-row {
            display: flex;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }
        #constant-error-tool #chatbot-input {
            flex: 1;
            border: none;
            padding: 0.75rem;
            font-size: 1rem;
            outline: none;
        }
        #constant-error-tool #chatbot-send {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0 1rem;
            font-size: 1.1rem;
            cursor: pointer;
        }
        #constant-error-tool #chatbot-resizer {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 22px;
            height: 22px;
            cursor: nwse-resize;
            z-index: 101;
            background: transparent;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
        }
        #constant-error-tool #chatbot-resizer:after {
            content: "";
            display: block;
            width: 16px;
            height: 16px;
            border-right: 2px solid #2563eb;
            border-bottom: 2px solid #2563eb;
            border-radius: 0 0 4px 0;
            margin: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="constant-error-tool">
      <div class="container">
        <header>
            <h1>Interactive Tool</h1>
            <p>Click on the target to throw darts and measure your own error.</p>
        </header>

        <div class="main-grid">
            <div class="panel panel-controls">
                <h2>Instructions</h2>
                <div class="instructions">
                   <p>1. Click on the target area to the right to "throw" a dart.</p>
                   <p>2. The tool records how far above (+) or below (-) the red "True Value" line your throw lands.</p>
                   <p>3. After 10 throws, the average error is calculated automatically.</p>
                </div>
                <div id="throw-counter-container">
                    <h3>Throws</h3>
                    <div class="counter-display">
                        <span id="throw-count">0</span> / 10
                    </div>
                </div>
                <div class="reset-container">
                    <button id="resetBtn">Reset</button>
                </div>
            </div>

            <div class="panel panel-dartboard">
              <div id="dartboard-container">
                <div class="scale-container">
                    <div style="top: 0%;">+25 cm</div>
                    <div style="top: 25%;">+12.5 cm</div>
                    <div style="top: 50%;" class="scale-0">0 cm</div>
                    <div style="bottom: 25%;">-12.5 cm</div>
                    <div style="bottom: 0%;">-25 cm</div>
                </div>
                <div id="targetArea">
                  <div class="true-value-line">
                     <span>True Value</span>
                  </div>
                  <div id="averageLine" class="hidden">
                       <span id="averageLineLabel">Average</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel panel-results">
                <h2>Results</h2>
                <div id="results-content">
                     <div class="placeholder">
                        <p>Click on the target to begin throwing.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chatbot-btn"
         title="Ask AI"
         role="button"
         aria-label="Chatbot"
         tabindex="0">
        üí¨
    </div>
    <div id="chatbot-modal" aria-modal="true" role="dialog">
        <div id="chatbot-header">
            <span>Ask Scott-e lite</span>
            <button id="chatbot-close" aria-label="Close">&times;</button>
        </div>
        <div id="chatbot-messages"></div>
        <form id="chatbot-input-row" autocomplete="off">
            <input id="chatbot-input" type="text" placeholder="Type your question..." autocomplete="off" aria-label="Chatbot text input" />
            <button id="chatbot-send" type="submit" aria-label="Send message">Send</button>
        </form>
        <div id="chatbot-resizer" aria-hidden="true"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Elements
        const resetBtn = document.getElementById('resetBtn');
        const targetArea = document.getElementById('targetArea');
        const averageLine = document.getElementById('averageLine');
        const averageLineLabel = document.getElementById('averageLineLabel');
        const resultsContent = document.getElementById('results-content');
        const throwCountEl = document.getElementById('throw-count');

        // State
        let throws = [];
        const MAX_THROWS = 10;

        // Formatting utilities
        const formatValue = (num) => {
            const fixedNum = num.toFixed(1);
            return num >= 0 ? `+${fixedNum}` : fixedNum;
        };
        const mapPixelsToCm = (yPosition, targetHeight) => {
            const percentage = yPosition / targetHeight;
            return (percentage - 0.5) * -50;
        };
        const mapCmToPercentage = (cm) => {
            const clampedCm = Math.max(-25, Math.min(25, cm));
            return 50 - (clampedCm / 25) * 50;
        };

        // Core interaction
        function handleTargetClick(e) {
            if (throws.length >= MAX_THROWS) {
                if (!document.querySelector('.full-message')) {
                    const p = document.createElement('p');
                    p.className = 'full-message';
                    p.textContent = 'Throw limit reached. Please Reset.';
                    document.getElementById('throw-counter-container').appendChild(p);
                }
                return;
            }
            const rect = targetArea.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const cmValue = mapPixelsToCm(y, rect.height);
            throws.push(cmValue);
            renderDart(x, y);
            updateResults();
            updateThrowCounter();
        }

        function renderDart(x, y) {
            const dartEl = document.createElement('div');
            dartEl.className = 'dart';
            dartEl.style.left = `${x}px`;
            dartEl.style.top = `${y}px`;
            targetArea.appendChild(dartEl);
        }

        async function updateResults() {
            if (throws.length === 0) {
                resultsContent.innerHTML = `
                  <div class="placeholder">
                    <p>Click on the target to begin throwing.</p>
                  </div>`;
                return;
            }
            if (throws.length === 1) {
                resultsContent.innerHTML = `
                  <div id="summary-container"></div>
                  <div>
                    <div class="log-header">
                      <h3>Throw Log</h3>
                      <button id="copyLogBtn" type="button">Copy Log</button>
                    </div>
                    <ul id="throw-log"></ul>
                  </div>`;
                document.getElementById('copyLogBtn').addEventListener('click', () => {
                    let data = 'Throw\tError(cm)\n';
                    throws.forEach((val, idx) => {
                        data += `${idx + 1}\t${formatValue(val)}\n`;
                    });
                    navigator.clipboard.writeText(data).then(() => alert('Throw log copied to clipboard!'));
                });
            }
            const throwLogEl = document.getElementById('throw-log');
            const last = throws[throws.length - 1];
            const li = document.createElement('li');
            li.innerHTML = `<span>Throw ${throws.length}:</span><span class="value">${formatValue(last)} cm</span>`;
            throwLogEl.appendChild(li);
            throwLogEl.scrollTop = throwLogEl.scrollHeight;

            if (throws.length === MAX_THROWS) {
                const { average, absAvg, stdDev, ceFormula, aeFormula, veFormula } = calculateMetrics();
                document.getElementById('summary-container').innerHTML = `
                  <h3>Final Summary</h3>
                  <div class="summary-box">
                    <div class="tooltip">
                      <span class="label">Constant Error ùë•ÃÑ:</span>
                      <span class="value">${formatValue(average)} cm</span>
                      <span class="tooltip-text">Calculation: ${ceFormula} = ${formatValue(average)} cm</span>
                    </div>
                    <div class="tooltip">
                      <span class="label">Absolute Error |ùë•ÃÑ|:</span>
                      <span class="value">${formatValue(absAvg)} cm</span>
                      <span class="tooltip-text">Calculation: ${aeFormula} = ${formatValue(absAvg)} cm</span>
                    </div>
                    <div class="tooltip">
                      <span class="label">Variable Error (SD):</span>
                      <span class="value">${formatValue(stdDev)} cm</span>
                      <span class="tooltip-text">Calculation: ${veFormula} = ${formatValue(stdDev)} cm</span>
                    </div>
                  </div>`;
                averageLine.style.top = `${mapCmToPercentage(average)}%`;
                averageLineLabel.textContent = `Avg: ${formatValue(average)} cm`;
                averageLine.classList.remove('hidden');

                if (!hasShownAnalysisPrompt && chatbotAvailable && chatbotSession) {
                    hasShownAnalysisPrompt = true;
                    try {
                        deliverProactiveMessage("Analyzing your performance...");

                        let context = `Here is the current context of the user's performance:\nThrows made: ${throws.length} / ${MAX_THROWS}\nThrow Log (deviation from center in cm):\n`;
                        throws.forEach((v, i) => { context += `- Throw ${i + 1}: ${formatValue(v)}\n`; });
                        context += `\nFinal Summary:\n- Constant Error: ${formatValue(average)} cm (Calculation: ${ceFormula})\n`;
                        context += `- Absolute Error: ${formatValue(absAvg)} cm (Calculation: ${aeFormula})\n`;
                        context += `- Variable Error (SD): ${formatValue(stdDev)} cm (Calculation: ${veFormula})\n`;
                        context += `\n---\nUser question: How was my performance?`;

                        const brief = await chatbotSession.prompt(context);
                        
                        // Replace the "Analyzing..." message with the actual brief.
                        if (chatIsOpen()) {
                            const messages = chatbotMessages.querySelectorAll('.chatbot-msg-assistant');
                            const lastMessage = messages[messages.length - 1];
                            if (lastMessage && lastMessage.textContent.includes("Analyzing your performance...")) {
                                lastMessage.innerHTML = `<span><b>Assistant:</b> </span><div class="prose prose-sm">${marked.parse(brief)}</div>`;
                            } else {
                                renderAssistantMessage(marked.parse(brief));
                            }
                        } else {
                            proactiveMessageQueue.pop(); // remove "Analyzing..."
                            const fullBrief = brief + "\n\nYou can ask me for more details, or what these concepts mean.";
                            queueProactiveMessage(marked.parse(fullBrief));
                        }
                    } catch (e) {
                        console.error("Failed to get AI performance brief:", e);
                        deliverProactiveMessage("I had trouble analyzing your performance. Please ask me about it directly.");
                    }
                }
            }
        }

        function calculateMetrics() {
            const sum = throws.reduce((a, v) => a + v, 0);
            const average = sum / throws.length;
            const absSum = throws.reduce((a, v) => a + Math.abs(v), 0);
            const absAvg = absSum / throws.length;
            const n = throws.length;
            const ssd = throws.reduce((a, v) => a + Math.pow(v - average, 2), 0);
            const stdDev = Math.sqrt(ssd / (n - 1));
            const ceFormula = `(${throws.map(t => formatValue(t)).join(' + ')}) / ${throws.length}`;
            const aeFormula = `(${throws.map(t => `|${formatValue(t)}|`).join(' + ')}) / ${throws.length}`;
            const veFormula = `sqrt(Œ£(x·µ¢ - xÃÑ)¬≤ / (n-1))`;
            return { average, absAvg, stdDev, ceFormula, aeFormula, veFormula };
        }

        function updateThrowCounter() {
            throwCountEl.textContent = throws.length;
        }

        function handleReset() {
            throws = [];
            targetArea.querySelectorAll('.dart').forEach(d => d.remove());
            averageLine.classList.add('hidden');
            resultsContent.innerHTML = `
                <div class="placeholder">
                    <p>Click on the target to begin throwing.</p>
                </div>`;
            updateThrowCounter();
            const fm = document.querySelector('.full-message');
            if (fm) fm.remove();

            // Reset proactive flags
            hasShownAnalysisPrompt = false;
            hasShownWelcomePrompt = false;
            proactiveMessageQueue = [];
            hasUnreadProactiveMessage = false;
            updateChatbotIcon();

            if (chatbotAvailable) {
                deliverProactiveMessage("Session reset. Start throwing again when you‚Äôre ready; I‚Äôll summarize once you reach 10 throws.");
            }
        }

        targetArea.addEventListener('click', handleTargetClick);
        resetBtn.addEventListener('click', handleReset);

        // Chatbot logic
        const chatbotBtn = document.getElementById('chatbot-btn');
        const chatbotModal = document.getElementById('chatbot-modal');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInputRow = document.getElementById('chatbot-input-row');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotResizer = document.getElementById('chatbot-resizer');

        let chatbotSession = null;
        let chatbotAvailable = false;
        let chatbotError = "AI assistant is not available. Your browser may not support the on-device model, or it may be disabled.";

        // Proactive state
        let proactiveMessageQueue = [];
        let hasUnreadProactiveMessage = false;
        let hasShownAnalysisPrompt = false;
        let hasShownWelcomePrompt = false;

        const WELCOME_MESSAGE = "Hi! I am Scott-e lite. Click anywhere on the target to start generating data. I can help understand measurements once you have a few throws.";

        function chatIsOpen() {
            return chatbotModal.style.display === 'flex';
        }

        function renderAssistantMessage(message, isError = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chatbot-msg-assistant';
            msgDiv.innerHTML = `<span><b>Assistant:</b> ${isError ? `<em style="color:#ef4444;">${message}</em>` : message}</span>`;
            chatbotMessages.appendChild(msgDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        function displayChatbotSystemMessage(message, isError = false) {
            renderAssistantMessage(message, isError);
        }

        function queueProactiveMessage(msg) {
            proactiveMessageQueue.push(msg);
            hasUnreadProactiveMessage = true;
            updateChatbotIcon();
        }

        function flushProactiveMessages() {
            proactiveMessageQueue.forEach(m => renderAssistantMessage(m));
            proactiveMessageQueue = [];
            hasUnreadProactiveMessage = false;
            updateChatbotIcon();
        }

        function deliverProactiveMessage(msg) {
            if (!chatbotAvailable) return;
            if (chatIsOpen()) {
                renderAssistantMessage(msg);
            } else {
                queueProactiveMessage(msg);
            }
        }

        function deliverInitialGreeting() {
            if (hasShownWelcomePrompt || !chatbotAvailable || throws.length > 0) return;
            hasShownWelcomePrompt = true;
            deliverProactiveMessage(WELCOME_MESSAGE);
        }

        function updateChatbotIcon() {
            chatbotBtn.classList.remove('is-unavailable', 'is-active', 'has-notification');
            if (!chatbotAvailable) {
                chatbotBtn.classList.add('is-unavailable');
                chatbotBtn.setAttribute('aria-label', 'Chatbot unavailable');
                return;
            }
            chatbotBtn.classList.add('is-active');
            if (hasUnreadProactiveMessage) {
                chatbotBtn.classList.add('has-notification');
                chatbotBtn.setAttribute('aria-label', 'Chatbot (new message)');
            } else {
                chatbotBtn.setAttribute('aria-label', 'Chatbot');
            }
        }

        chatbotBtn.onclick = () => {
            chatbotModal.style.display = 'flex';
            chatbotInput.disabled = !chatbotAvailable;
            if (chatbotAvailable) chatbotInput.focus();
            if (hasUnreadProactiveMessage) flushProactiveMessages();
        };

        chatbotBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                chatbotBtn.click();
            }
        });

        chatbotClose.onclick = () => {
            chatbotModal.style.display = 'none';
        };

        // Resizing
        let resizing = false, startX, startY, startW, startH;
        chatbotResizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            resizing = true;
            chatbotModal.classList.add('resizing');
            startX = e.clientX;
            startY = e.clientY;
            startW = chatbotModal.offsetWidth;
            startH = chatbotModal.offsetHeight;
            document.body.style.cursor = 'nwse-resize';
        });
        window.addEventListener('mousemove', (e) => {
            if (!resizing) return;
            const newW = Math.max(250, Math.min(600, startW + (e.clientX - startX)));
            const newH = Math.max(200, Math.min(600, startH + (e.clientY - startY)));
            chatbotModal.style.width = newW + 'px';
            chatbotModal.style.height = newH + 'px';
        });
        window.addEventListener('mouseup', () => {
            if (resizing) {
                resizing = false;
                chatbotModal.classList.remove('resizing');
                document.body.style.cursor = '';
            }
        });

        async function setupChatbot() {
            chatbotMessages.innerHTML = '';
            try {
                if (!('LanguageModel' in window)) {
                    throw new Error("The on-device AI model is not available in this browser.");
                }
                const availabilityOptions = { expectedInputs: [{ type: "text", languages: ["en"] }] };
                const availability = await window.LanguageModel.availability(availabilityOptions);
                if (availability === "unavailable") {
                    throw new Error("The on-device AI model is not supported by your device.");
                }
                if (availability === "downloadable") {
                    displayChatbotSystemMessage("Model is downloadable and will load when you send your first message.");
                }

                const systemPrompt = `
You are 'Scott-e lite', an AI assistant for an interactive measurement error tool.
You ONLY help users understand constant error, absolute error, variable error, and interpreting their recorded throws (metaphor only).
Rules:
1. Do NOT give physical throwing technique.
2. Response in most concise words.
3. Stay on topic (measurement error). Politely refuse off-topic queries.
4. Use provided throws and derived metrics to explain performance clearly.
`;
                chatbotSession = await window.LanguageModel.create({
                    temperature: 0.8,
                    topK: 3,
                    initialPrompts: [{ role: "system", content: systemPrompt }],
                    expectedInputs: [{ type: "text", languages: ["en"] }]
                });
                chatbotAvailable = true;
            } catch (e) {
                chatbotAvailable = false;
                chatbotSession = null;
                console.error("Chatbot setup failed:", e.message);
                displayChatbotSystemMessage(e.message, true);
            } finally {
                updateChatbotIcon();
                deliverInitialGreeting();
            }
        }
        setupChatbot();

        chatbotInputRow.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!chatbotAvailable || !chatbotSession) {
                renderAssistantMessage(chatbotError, true);
                return;
            }
            const msg = chatbotInput.value.trim();
            if (!msg) return;
            const userDiv = document.createElement('div');
            userDiv.className = 'chatbot-msg-user';
            userDiv.innerHTML = `<span><b>You:</b> ${msg}</span>`;
            chatbotMessages.appendChild(userDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            chatbotInput.value = '';

            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'chatbot-msg-assistant';
            thinkingDiv.innerHTML = `<span><b>Assistant:</b> <em>Thinking...</em></span>`;
            chatbotMessages.appendChild(thinkingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            let context;
            if (throws.length === 0) {
                context = "The user has not thrown any darts yet.\n---\nUser question: " + msg;
            } else {
                context = `Here is the current context of the user's performance:\nThrows made: ${throws.length} / ${MAX_THROWS}\nThrow Log (deviation from center in cm):\n`;
                throws.forEach((v, i) => { context += `- Throw ${i + 1}: ${formatValue(v)}\n`; });
                if (throws.length === MAX_THROWS) {
                    const { average, absAvg, stdDev, ceFormula, aeFormula, veFormula } = calculateMetrics();
                    context += `\nFinal Summary:\n- Constant Error: ${formatValue(average)} cm (Calculation: ${ceFormula})\n`;
                    context += `- Absolute Error: ${formatValue(absAvg)} cm (Calculation: ${aeFormula})\n`;
                    context += `- Variable Error (SD): ${formatValue(stdDev)} cm (Calculation: ${veFormula})\n`;
                }
                context += `\n---\nUser question: ${msg}`;
            }

            try {
                const response = await chatbotSession.prompt(context);
                thinkingDiv.innerHTML = `<span><b>Assistant:</b> </span><div class="prose prose-sm">${marked.parse(response)}</div>`;
            } catch {
                thinkingDiv.innerHTML = `<span><b>Assistant:</b> Sorry, something went wrong.</span>`;
            }
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        });

        window.addEventListener('mousedown', (e) => {
            if (chatbotModal.style.display === 'flex' && !chatbotModal.contains(e.target) && e.target !== chatbotBtn) {
                chatbotModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
